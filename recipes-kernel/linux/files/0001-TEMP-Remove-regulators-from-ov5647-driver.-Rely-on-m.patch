From 89810f957b1467c81312f607b09160e15950fa87 Mon Sep 17 00:00:00 2001
From: wireless-hazard <magnocostamaia@gmail.com>
Date: Sat, 15 Nov 2025 22:16:06 -0300
Subject: [PATCH] [TEMP] Remove regulators from ov5647 driver. Rely on manually
 calling ov5647-regulator device driver before probing

---
 drivers/media/i2c/ov5647.c | 18 +++++++++++-------
 1 file changed, 11 insertions(+), 7 deletions(-)

diff --git a/drivers/media/i2c/ov5647.c b/drivers/media/i2c/ov5647.c
index 3f89974963e0..485d93dfe12e 100644
--- a/drivers/media/i2c/ov5647.c
+++ b/drivers/media/i2c/ov5647.c
@@ -20,7 +20,7 @@
 #include <linux/module.h>
 #include <linux/of_graph.h>
 #include <linux/pm_runtime.h>
-#include <linux/regulator/consumer.h>
+//#include <linux/regulator/consumer.h>
 #include <linux/slab.h>
 #include <linux/videodev2.h>
 #include <media/v4l2-ctrls.h>
@@ -84,12 +84,14 @@
 #define OV5647_EXPOSURE_DEFAULT		1000
 #define OV5647_EXPOSURE_MAX		65535
 
+#if 0
 /* regulator supplies */
 static const char * const ov5647_supply_names[] = {
 	"avdd",		/* Analog power */
 	"dovdd",	/* Digital I/O power */
 	"dvdd",		/* Digital core power */
 };
+#endif
 
 #define OV5647_NUM_SUPPLIES ARRAY_SIZE(ov5647_supply_names)
 
@@ -114,7 +116,7 @@ struct ov5647 {
 	struct mutex			lock;
 	struct clk			*xclk;
 	struct gpio_desc		*pwdn;
-	struct regulator_bulk_data supplies[OV5647_NUM_SUPPLIES];
+//	struct regulator_bulk_data supplies[OV5647_NUM_SUPPLIES];
 	bool				clock_ncont;
 	struct v4l2_ctrl_handler	ctrls;
 	const struct ov5647_mode	*mode;
@@ -802,11 +804,11 @@ static int ov5647_stream_off(struct v4l2_subdev *sd)
 static int ov5647_power_on(struct device *dev)
 {
 	struct ov5647 *sensor = dev_get_drvdata(dev);
-	int ret;
+	int ret = 0;
 
 	dev_dbg(dev, "OV5647 power on\n");
 
-	ret = regulator_bulk_enable(OV5647_NUM_SUPPLIES, sensor->supplies);
+//	ret = regulator_bulk_enable(OV5647_NUM_SUPPLIES, sensor->supplies);
 	if (ret < 0) {
 		dev_err(dev, "Failed to enable regulators\n");
 		return ret;
@@ -843,7 +845,7 @@ static int ov5647_power_on(struct device *dev)
 	clk_disable_unprepare(sensor->xclk);
 error_pwdn:
 	gpiod_set_value_cansleep(sensor->pwdn, 1);
-	regulator_bulk_disable(OV5647_NUM_SUPPLIES, sensor->supplies);
+//	regulator_bulk_disable(OV5647_NUM_SUPPLIES, sensor->supplies);
 
 	return ret;
 }
@@ -873,7 +875,7 @@ static int ov5647_power_off(struct device *dev)
 
 	clk_disable_unprepare(sensor->xclk);
 	gpiod_set_value_cansleep(sensor->pwdn, 1);
-	regulator_bulk_disable(OV5647_NUM_SUPPLIES, sensor->supplies);
+//	regulator_bulk_disable(OV5647_NUM_SUPPLIES, sensor->supplies);
 
 	return 0;
 }
@@ -1378,6 +1380,7 @@ static const struct v4l2_ctrl_ops ov5647_ctrl_ops = {
 	.s_ctrl = ov5647_s_ctrl,
 };
 
+#if 0
 static int ov5647_configure_regulators(struct device *dev,
 				       struct ov5647 *sensor)
 {
@@ -1389,6 +1392,7 @@ static int ov5647_configure_regulators(struct device *dev,
 	return devm_regulator_bulk_get(dev, OV5647_NUM_SUPPLIES,
 				       sensor->supplies);
 }
+#endif
 
 static int ov5647_init_controls(struct ov5647 *sensor, struct device *dev)
 {
@@ -1542,7 +1546,7 @@ static int ov5647_probe(struct i2c_client *client)
 		return -EINVAL;
 	}
 
-	ret = ov5647_configure_regulators(dev, sensor);
+//	ret = ov5647_configure_regulators(dev, sensor);
 	if (ret) {
 		dev_err(dev, "Failed to get power regulators\n");
 		return ret;
